<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
	<link rel='stylesheet' type='text/css' href='assets/css/index.css'>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  </head>
 
	<body>
		<div id="chart"></div>
		<div id="dataset-picker"></div>
    
		<script type="text/javascript">
			// data aggregation
			var zipped = 0;
			
			$.ajax({
				type: 'GET',
				dataType: "json",
				async: true,
				url: 'https://cdn.rawgit.com/agjaeger/fred-viz/master/data/zipped.json',
				success: function(data) {
					zipped = data;
				}
			});
		
			// viz
			var margin = { top: 50, right: 0, bottom: 100, left: 100 };
			var width = 480 - margin.left - margin.right;
			var height = 480 - margin.top - margin.bottom;
			var gridSize = Math.floor(width / 6);
			var buckets = 9;
			var legendElementWidth = width / buckets;
			var colors = ["#CCE5FF","#99CCFF","#66B2FF","#3399FF","#0080FF","#0066CC","#004C99","#003366","#001933"]; 
			var dataLabels = ["EXPCH", "EXPGE", "EXPMX", "IMPCH", "IMPGE", "IMPMX"];

			var svg = d3.select("#chart").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			var leftLabels = svg.selectAll(".dayLabel")
				.data(dataLabels)
				.enter().append("text")
					.text(function (d) { return d; })
					.attr("x", 0)
					.attr("y", function (d, i) { return i * gridSize; })
					.style("text-anchor", "end")
					.attr("transform", "translate(-6," + gridSize / 1.5 + ")")
					.attr("class", function (d, i) { return ((i >= 0 && i <= 4) ? "dayLabel mono axis axis-workweek" : "dayLabel mono axis"); });

			var topLabels = svg.selectAll(".timeLabel")
				.data(dataLabels)
				.enter().append("text")
					.text(function(d) { return d; })
					.attr("x", function(d, i) { return i * gridSize; })
					.attr("y", 0)
					.style("text-anchor", "middle")
					.attr("transform", "translate(" + gridSize / 2 + ", -6)")
					.attr("class", function(d, i) { return ((i >= 7 && i <= 16) ? "timeLabel mono axis axis-worktime" : "timeLabel mono axis"); });

			var tip = d3.tip()
				.attr('class', 'd3-tip')
				.offset([-10, 0])
				.html(function(d) {
					return "<strong>Correlation:</strong> <span>" + d['value'].toFixed(4) + "</span>";
				});
			
			svg.call(tip);
			
			var lineGraph = function(key1, key2) {
				console.log(key1 + " " + key2);
			};
			
			var heatmapChart = function() {
				d3.json('https://cdn.rawgit.com/agjaeger/fred-viz/master/data/correlated.json',   
					function(error, data) {	
						var colorScale = d3.scale.quantile()
							.domain([0.0, 1.0])
							.range(colors);	

						var rects = svg.selectAll("rect")
							.data(d3.entries(data))
							.enter()
							.append("rect");

						var rectangle = rects
							.attr("x", function(d) {
								var index = dataLabels.indexOf(d['key'].split('-')[0]);
								return index * gridSize;
							})
							.attr("y", function(d) {
								var index = dataLabels.indexOf(d['key'].split('-')[1]);
								return index * gridSize;
							})
							.attr("rx", 4)
							.attr("ry", 4)
							.attr("width", gridSize - 10)
							.attr("height", gridSize - 10)
							.style("fill", function(d) { return colorScale(d['value']); })
							.on('mouseover', tip.show)
							.on('mouseout', tip.hide)
							.on('click', function(d) {
								var keyPair = d['key'].split('-');
								lineGraph(keyPair[0], keyPair[1]);
							});
							
						var legend = svg.selectAll(".legend")
							.data(d3.entries(data));

						legend.enter().append("g")
							.attr("class", "legend");

						legend.append("rect")
							.attr("id", function(d) { return d['key'] })
							.attr("x", function(d) { 
								var index = dataLabels.indexOf(d['key'].split('-')[0]);
								return legendElementWidth * index; 
							})
							.attr("y", height)
							.attr("width", legendElementWidth)
							.attr("height", gridSize / 2)
							.style("fill", function(d) {
								var index = dataLabels.indexOf(d['key'].split('-')[0]);
								return colors[index]; 
							});

						legend.append("text")
							.attr("class", "mono")
							.text(function(d) {
								return "â‰¥ " + Math.round(d); 
							})
							.attr("x", function(d, i) { return legendElementWidth * i; })
							.attr("y", height + gridSize);

						legend.exit().remove();
					}
				);  
			};
		
			heatmapChart();
		</script>
	</body>
</html>
